name: Reorganize Source Files

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "reorganize" to confirm'
        required: true
        default: ''

jobs:
  reorganize:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'reorganize'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Create directory structure
        run: |
          echo "Creating src/ directory structure..."
          mkdir -p src/core
          mkdir -p src/codegen
          mkdir -p src/ir
          mkdir -p src/compilers
          mkdir -p src/include
          mkdir -p tests
          echo "Directories created"
      
      - name: Move core compiler files
        run: |
          echo "Moving core compiler files..."
          git mv lexer.c src/core/ || true
          git mv parser.c src/core/ || true
          git mv parser_enhanced.c src/core/ || true
          git mv semantic.c src/core/ || true
          git mv type_system.c src/core/ || true
          git mv type_system.h src/core/ || true
          git mv error_handler.c src/core/ || true
          git mv error_handler.h src/core/ || true
          git mv utils.c src/core/ || true
          echo "Core files moved (9 files)"
      
      - name: Move code generation files
        run: |
          echo "Moving code generation files..."
          git mv codegen.c src/codegen/ 2>/dev/null || true
          git mv codegen_cpp.c src/codegen/ 2>/dev/null || true
          git mv codegen_cpp.h src/codegen/ 2>/dev/null || true
          git mv codegen_multilang.c src/codegen/ 2>/dev/null || true
          git mv codegen_native.c src/codegen/ 2>/dev/null || true
          git mv codegen_native.h src/codegen/ 2>/dev/null || true
          git mv codegen_rust.c src/codegen/ 2>/dev/null || true
          git mv codegen_rust.h src/codegen/ 2>/dev/null || true
          git mv codegen_x64.c src/codegen/ 2>/dev/null || true
          git mv codegen_x64.h src/codegen/ 2>/dev/null || true
          git mv targets.c src/codegen/ 2>/dev/null || true
          git mv targets.h src/codegen/ 2>/dev/null || true
          echo "Codegen files moved (12 files)"
      
      - name: Move IR files
        run: |
          echo "Moving IR files..."
          git mv ir.c src/ir/ 2>/dev/null || true
          git mv ir.h src/ir/ 2>/dev/null || true
          echo "IR files moved (2 files)"
      
      - name: Move compiler files
        run: |
          echo "Moving main compiler files..."
          git mv sub.c src/compilers/ 2>/dev/null || true
          git mv sub_multilang.c src/compilers/ 2>/dev/null || true
          git mv sub_native.c src/compilers/ 2>/dev/null || true
          git mv sub_native_compiler.c src/compilers/ 2>/dev/null || true
          echo "Compiler files moved (4 files)"
      
      - name: Move header files
        run: |
          echo "Moving header files..."
          git mv sub_compiler.h src/include/ || true
          git mv windows_compat.h src/include/ || true
          echo "Header files moved (2 files)"
      
      - name: Move test files
        run: |
          echo "Moving test .sb files..."
          git mv test_*.sb tests/ 2>/dev/null || true
          git mv simple_test.sb tests/ 2>/dev/null || true
          git mv example.sb tests/ 2>/dev/null || true
          echo "Test files moved"
      
      - name: Create README files for each directory
        run: |
          cat > src/core/README.md <<'EOFCORE'
          # Core Compiler Components
          
          This directory contains the core components of the SUB language compiler.
          
          ## Files
          
          - lexer.c - Tokenization and lexical analysis
          - parser.c - Basic parser implementation
          - parser_enhanced.c - Enhanced parser with additional features
          - semantic.c - Semantic analysis and symbol table management
          - type_system.c - Type system implementation
          - type_system.h - Type system header and definitions
          - error_handler.c - Error handling implementation
          - error_handler.h - Error handling header
          - utils.c - Utility functions for the compiler
          EOFCORE
          
          cat > src/codegen/README.md <<'EOFCODEGEN'
          # Code Generation Backends
          
          This directory contains all code generation backends for SUB language.
          
          ## Files
          
          ### Main Code Generation
          - codegen.c - Main code generation logic
          - targets.c - Target platform management
          - targets.h - Target platform definitions
          
          ### Language-Specific Backends
          - codegen_cpp.c/h - C++ code generation
          - codegen_rust.c/h - Rust code generation
          - codegen_x64.c/h - x86-64 assembly generation
          - codegen_native.c/h - Native compilation support
          - codegen_multilang.c - Multi-language transpilation
          EOFCODEGEN
          
          cat > src/ir/README.md <<'EOFIR'
          # Intermediate Representation
          
          This directory contains the intermediate representation layer.
          
          ## Files
          
          - ir.c - IR generation from AST
          - ir.h - IR data structures and definitions
          EOFIR
          
          cat > src/compilers/README.md <<'EOFCOMPILERS'
          # Main Compiler Executables
          
          This directory contains the main compiler driver programs.
          
          ## Files
          
          - sub.c - Standard SUB compiler
          - sub_multilang.c - Multi-language transpiler
          - sub_native.c - Native compiler (older version)
          - sub_native_compiler.c - Native compiler (newer version)
          EOFCOMPILERS
          
          cat > src/include/README.md <<'EOFINCLUDE'
          # Public Headers
          
          This directory contains public header files used across the compiler.
          
          ## Files
          
          - sub_compiler.h - Main compiler header with all declarations
          - windows_compat.h - Windows compatibility definitions
          EOFINCLUDE
          
          cat > tests/README.md <<'EOFTESTS'
          # Test Files
          
          This directory contains SUB language test files (.sb).
          
          ## Test Files
          
          - example.sb - Example program
          - simple_test.sb - Simple test case
          - test_*.sb - Various compiler test cases
          
          These files are used to test the compiler functionality.
          EOFTESTS
          
          git add src/*/README.md tests/README.md
          echo "README files created"
      
      - name: Verify reorganization
        run: |
          echo "Source Directory Structure:"
          ls -R src/
          echo ""
          echo "File Count:"
          echo "Core files: $(find src/core -name '*.c' -o -name '*.h' 2>/dev/null | wc -l)"
          echo "Codegen files: $(find src/codegen -name '*.c' -o -name '*.h' 2>/dev/null | wc -l)"
          echo "IR files: $(find src/ir -name '*.c' -o -name '*.h' 2>/dev/null | wc -l)"
          echo "Compiler files: $(find src/compilers -name '*.c' 2>/dev/null | wc -l)"
          echo "Header files: $(find src/include -name '*.h' 2>/dev/null | wc -l)"
          echo "Test files: $(find tests -name '*.sb' 2>/dev/null | wc -l)"
          echo "Total source: $(find src/ -name '*.c' -o -name '*.h' 2>/dev/null | wc -l) files"
          echo "Total tests: $(find tests/ -name '*.sb' 2>/dev/null | wc -l) files"
      
      - name: Commit changes
        run: |
          git status
          git add -A
          git commit -m "refactor: Complete source reorganization into src/ directory
          
          Reorganized all source files into logical directory structure:
          - src/core/ - Core compiler components (9 files)
          - src/codegen/ - Code generation backends (12 files)
          - src/ir/ - Intermediate representation (2 files)
          - src/compilers/ - Main compiler executables (4 files)
          - src/include/ - Public headers (2 files)
          - tests/ - Test .sb files (21 files)
          
          Total: 29 source files + 21 test files moved
          
          Benefits:
          - Clean root directory
          - Logical organization
          - Easier navigation
          - Professional structure
          - Better maintainability
          - Tests properly organized
          
          Part of repository cleanup and modernization.
          Automated via GitHub Actions workflow."
      
      - name: Push changes
        run: |
          git push origin main
          echo "Changes pushed successfully"
      
      - name: Summary
        run: |
          echo ""
          echo "================================================"
          echo "   SOURCE REORGANIZATION COMPLETE"
          echo "================================================"
          echo ""
          echo "All source files moved to src/ directory."
          echo "All test files moved to tests/ directory."
          echo ""
          echo "Next steps:"
          echo "  1. Update Makefile to use new paths"
          echo "  2. Update CMakeLists.txt"
          echo "  3. Update include paths in source files"
          echo "  4. Update test scripts"
          echo "  5. Test compilation"
          echo ""
          echo "See: docs/implementation/SRC_REORGANIZATION_PLAN.md"
          echo "================================================"
